# app.py
# -*- coding: utf-8 -*-
"""
ì—¬ê³ ìƒ ëŒ€ìƒ ê³ ë¯¼ìƒë‹´ ì›¹ì•± (Streamlit)
- ìƒë…„ì›”ì¼ ì…ë ¥ â†’ ë³„ìë¦¬/ê°„ë‹¨ ì‚¬ì£¼í’(ì˜¤í–‰/ë ) ì¶”ì •
- 4ê°œ ì¹´í…Œê³ ë¦¬: í•™ì—…, ì§„ë¡œ, ìš´ì„¸, ì—°ì•  ë° ì¸ê°„ê´€ê³„
- ì¹´í…Œê³ ë¦¬ë³„ ë§ì¶¤ ì¡°ì–¸/í•´ê²°ì±… ìƒì„± + í•  ì¼ ì²´í¬ë¦¬ìŠ¤íŠ¸
- íƒœì–´ë‚œ "ë‹¬" Ã— ì¹´í…Œê³ ë¦¬ ì¡°í•©(12 Ã— 4 = 48)ì— ë§ì¶˜ ì‹¬ì‹  ì•ˆì • ë°°ê²½ìŒì•…
    - 1) ì‚¬ìš©ì ì—…ë¡œë“œ(ê¶Œì¥): mp3/wav/flac ë“± 48ê°œ íŒŒì¼ ë§¤í•‘
    - 2) URL ì¬ìƒ: ê° ì¡°í•©ì— URLì„ ì„¤ì • ê°€ëŠ¥ (config íƒ­)
    - 3) ë‚´ì¥ ìƒì„± BGM: í•©ì„±(ì‚¬ì¸íŒŒ/ì„œë¸Œë² ì´ìŠ¤/ì•°ë¹„ì–¸ìŠ¤)ë¡œ ì¦‰ì„ ìƒì„± (ê¸°ë³¸ê°’)

ì‚¬ìš©ë²•
- streamlit run app.py
- ì¢Œì¸¡ ì‚¬ì´ë“œë°”ì—ì„œ ìƒë…„ì›”ì¼, ì¹´í…Œê³ ë¦¬, ê³ ë¯¼ ì…ë ¥ í›„ ê²°ê³¼ ë³´ê¸°
"""

import io
import datetime as dt
from dataclasses import dataclass
from typing import Dict, List, Tuple, Optional

import numpy as np
import streamlit as st

# ----------------------------- ìƒìˆ˜/ìœ í‹¸ -----------------------------
CATEGORIES = ["í•™ì—…", "ì§„ë¡œ", "ìš´ì„¸", "ì—°ì•  ë° ì¸ê°„ê´€ê³„"]
MONTHS_KR = ["1ì›”", "2ì›”", "3ì›”", "4ì›”", "5ì›”", "6ì›”", "7ì›”", "8ì›”", "9ì›”", "10ì›”", "11ì›”", "12ì›”"]

@dataclass
class UserProfile:
    name: str
    birthdate: dt.date
    zodiac: str  # ì„œì–‘ ë³„ìë¦¬
    zodiac_animal: str  # 12ë (ê°„ë‹¨)
    element: str  # ì˜¤í–‰(ê°„ë‹¨ ë§¤í•‘)

# ----------------------------- ë³„ìë¦¬/ë /ì˜¤í–‰ -----------------------------

def western_zodiac(d: dt.date) -> str:
    zds = [
        ((1, 20), "ë¬¼ë³‘ìë¦¬"), ((2, 19), "ë¬¼ê³ ê¸°ìë¦¬"), ((3, 21), "ì–‘ìë¦¬"),
        ((4, 20), "í™©ì†Œìë¦¬"), ((5, 21), "ìŒë‘¥ì´ìë¦¬"), ((6, 22), "ê²Œìë¦¬"),
        ((7, 23), "ì‚¬ììë¦¬"), ((8, 23), "ì²˜ë…€ìë¦¬"), ((9, 23), "ì²œì¹­ìë¦¬"),
        ((10, 24), "ì „ê°ˆìë¦¬"), ((11, 23), "ì‚¬ìˆ˜ìë¦¬"), ((12, 22), "ì—¼ì†Œìë¦¬"),
    ]
    m, day = d.month, d.day
    for (edge_m, edge_d), name in zds:
        if (m, day) < (edge_m, edge_d):
            return prev_name
        prev_name = name
    return "ì—¼ì†Œìë¦¬"


def korean_zodiac_animal(year: int) -> str:
    animals = ["ì¥", "ì†Œ", "í˜¸ë‘ì´", "í† ë¼", "ìš©", "ë±€", "ë§", "ì–‘", "ì›ìˆ­ì´", "ë‹­", "ê°œ", "ë¼ì§€"]
    idx = (year - 2008) % 12
    return animals[idx]


def element_from_month(month: int) -> str:
    mapping = {
        1: "ìˆ˜", 2: "ìˆ˜", 3: "ëª©", 4: "ëª©", 5: "í™”", 6: "í™”",
        7: "í† ", 8: "í† ", 9: "ê¸ˆ", 10: "ê¸ˆ", 11: "ìˆ˜", 12: "ìˆ˜",
    }
    return mapping.get(month, "í† ")

# ----------------------------- ì¡°ì–¸ ìƒì„± -----------------------------

def seed_rng(date: dt.date, category: str) -> np.random.Generator:
    seed = int(date.strftime("%m%d")) * 100 + (CATEGORIES.index(category) + 1)
    return np.random.default_rng(seed)


def advice_blocks(profile: UserProfile, category: str, concern: str) -> Tuple[str, List[str], List[str]]:
    rng = seed_rng(profile.birthdate, category)
    tone_words = {
        "ìˆ˜": ("ì°¨ë¶„í•¨", "ì •ë¦¬"),
        "ëª©": ("ì„±ì¥", "ê³„íš"),
        "í™”": ("ì¶”ì§„", "ìš©ê¸°"),
        "í† ": ("ì§‘ì¤‘", "ê¾¸ì¤€í•¨"),
        "ê¸ˆ": ("ê· í˜•", "ì ˆì œ"),
    }
    t1, t2 = tone_words.get(profile.element, ("ê· í˜•", "ì •ë¦¬"))

    if category == "í•™ì—…":
        summary = f"{profile.zodiac}ì˜ ì„±í–¥ì„ ì‚´ë ¤ {t1}í•˜ê²Œ ê³µë¶€ ë£¨í‹´ì„ ì¡ì•„ë³´ì. í•µì‹¬ì€ {t2}ì™€ ë°˜ë³µì´ë‹¤."
        tasks = [
            "25ë¶„ ì§‘ì¤‘ ê³µë¶€ Ã— 3ì„¸íŠ¸", 
            f"ì·¨ì•½ ê³¼ëª©ì—ì„œ ê°œë… 3ê°œ ì •ë¦¬ ({profile.element} ì„±í–¥ ë°˜ì˜)",
            "ë§¤ì¼ ê°™ì€ ì‹œê°„Â·ì¥ì†Œ í•™ìŠµ ì‹œë„",
            "ë‹¤ìŒë‚  ì•„ì¹¨ ìŠ¤ìŠ¤ë¡œ í…ŒìŠ¤íŠ¸ ë§Œë“¤ê¸°"
        ]
        support = [
            "ì‘ì€ ì„±ì·¨ê°€ í° ë³€í™”ë¥¼ ë§Œë“ ë‹¤.",
            f"{profile.birthdate.month}ì›”ì€ ìƒˆ ìŠµê´€ì´ ì˜ ìë¦¬ì¡ëŠ” ì‹œê¸°ì•¼."
        ]

    elif category == "ì§„ë¡œ":
        summary = f"{t1}í•œ íƒìƒ‰ê³¼ {t2}ê°€ ì§„ë¡œì˜ ì‹¤ë§ˆë¦¬ë¥¼ ì¤„ ê±°ì•¼."
        tasks = [
            "ì´ë²ˆ ì£¼ í¥ë¯¸ë¡œì› ë˜ ìˆœê°„ 3ê°œ ê¸°ë¡",
            "ê´€ì‹¬ ì§ì—…/ì „ê³µ í‚¤ì›Œë“œ 5ê°œ ì¡°ì‚¬",
            "í•™êµÂ·ì§€ì—­ í–‰ì‚¬ 1ê°œ ì°¸ì—¬ ì‹ ì²­",
            "ì„ ìƒë‹˜Â·ì„ ë°°ì—ê²Œ ì§ˆë¬¸í•˜ê¸°"
        ]
        support = [
            "ì§„ë¡œëŠ” í•œ ë²ˆì— ì •ë‹µì„ ì°¾ëŠ” ê²Œ ì•„ë‹ˆì•¼.",
            "ì‘ì€ ê²½í—˜ë“¤ì´ ë¯¸ë˜ë¥¼ ì—°ê²°í•´ ì¤€ë‹¤."
        ]

    elif category == "ìš´ì„¸":
        summary = f"ì˜¤ëŠ˜ì˜ í‚¤ì›Œë“œëŠ” '{t1}'. ì‘ì€ ì •ë¦¬ê°€ ì¢‹ì€ ìš´ì„ ë¶ˆëŸ¬."
        tasks = [
            "ì±…ìƒ 10ë¶„ ì •ë¦¬í•˜ê¸°",
            "í•  ì¼ 3ê°œë§Œ ì •í•´ì„œ ìš°ì„ ìˆœìœ„ í‘œì‹œ",
            "10ë¶„ ì‚°ì±… í›„ ë§ˆìŒ ì •ë¦¬",
            "ì˜¤ëŠ˜ ì˜í•œ ì¼ 1ê°€ì§€ ê¸°ë¡"
        ]
        support = [
            "ìš´ì€ ì¤€ë¹„ëœ ë§ˆìŒì„ ì¢‹ì•„í•´.",
            f"{profile.element} ê¸°ìš´ì´ ê°•í•œ ë‚ ì´ì•¼."
        ]

    else:  # ì—°ì•  ë° ì¸ê°„ê´€ê³„
        summary = f"ê´€ê³„ë¥¼ {t1}í•˜ê²Œ, ì†ë„ëŠ” {t2}ë¡œ ì¡°ì ˆí•´ ë³´ì."
        tasks = [
            "ëŒ€í™”ì—ì„œ ì†”ì§í•œ í•œ ë¬¸ì¥ í‘œí˜„í•˜ê¸°",
            "ìƒëŒ€ë°© ì¥ì  1ê°€ì§€ êµ¬ì²´ì ìœ¼ë¡œ ì¹­ì°¬í•˜ê¸°",
            "ë‚˜ì˜ ë°”ëŒì„ I-Messageë¡œ ì „ë‹¬",
            "ì•½ì† 1ê°œ(ì‹œê°„Â·ì—°ë½ ë¹ˆë„) í•©ì˜"
        ]
        support = [
            "ê´€ê³„ëŠ” í•¨ê»˜ ë§Œë“¤ì–´ê°€ëŠ” ê±°ì•¼.",
            "ë„ˆì˜ ì§„ì‹¬ì´ ì¶©ë¶„íˆ ì „ë‹¬ë  ê±°ì•¼."
        ]

    if concern.strip():
        summary += f" (ê³ ë¯¼: '{concern[:30] + ('â€¦' if len(concern) > 30 else '')}')"

    if len(tasks) > 0:
        idx = rng.integers(0, len(tasks))
        tasks[idx] = "âœ… " + tasks[idx]

    return summary, tasks, support

# ----------------------------- Streamlit UI -----------------------------

st.set_page_config(page_title="ê³ ë¯¼ìƒë‹´ â€” ì—¬ê³ ìƒ ë§ì¶¤", page_icon="ğŸ’¬", layout="wide")

st.title("ì—¬ê³ ìƒ ë§ì¶¤ ê³ ë¯¼ìƒë‹´ ğŸ’¬âœ¨")

with st.sidebar:
    st.header("ê¸°ë³¸ ì •ë³´")
    name = st.text_input("ì´ë¦„ (ì„ íƒ)", placeholder="ë‹‰ë„¤ì„ë„ ì¢‹ì•„ìš”")
    birth = st.date_input("ìƒë…„ì›”ì¼", value=dt.date(2007, 1, 1), format="YYYY-MM-DD")
    category = st.selectbox("ìƒë‹´ ì¹´í…Œê³ ë¦¬", CATEGORIES, index=0)
    concern = st.text_area("ì§€ê¸ˆ ê³ ë¯¼ í•œ ì¤„", placeholder="ì˜ˆ: ì§„ë¡œê°€ ë§‰ë§‰í•´ìš”â€¦")

profile = UserProfile(
    name=name.strip() or "ìµëª…",
    birthdate=birth,
    zodiac=western_zodiac(birth),
    zodiac_animal=korean_zodiac_animal(birth.year),
    element=element_from_month(birth.month),
)

st.subheader("ğŸ”® í”„ë¡œí•„")
st.markdown(
    f"""
    - ì´ë¦„: **{profile.name}**  
    - ìƒë…„ì›”ì¼: **{profile.birthdate.strftime('%Y-%m-%d')}**  
    - ë³„ìë¦¬: **{profile.zodiac}** Â· ë : **{profile.zodiac_animal}ë ** Â· ì˜¤í–‰: **{profile.element}**
    """
)

st.subheader("ğŸ§  ìƒë‹´ ê²°ê³¼")
summary, tasks, support = advice_blocks(profile, category, concern)
st.markdown(f"**ìš”ì•½:** {summary}")

st.markdown("**ì‹¤í–‰ ì²´í¬ë¦¬ìŠ¤íŠ¸**")
for t in tasks:
    st.checkbox(t, key=f"chk-{category}-{t}")

st.markdown("**ì‘ì›/ê²©ë ¤**")
for s in support:
    st.caption("â€¢ " + s)

st.caption("Made with â¤ï¸ for í•™ìƒ ìƒë‹´ Â· Streamlit")
